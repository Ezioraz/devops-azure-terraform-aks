trigger:
- main

variables:
- group: azure-sp-secrets

stages:
- stage: Deploy
  displayName: Deploy to AKS
  jobs:
  - job: Deploy
    displayName: Login to Azure and deploy to AKS
    pool:
      name: self-hosted

    steps:
    - checkout: self

    - task: CmdLine@2
      displayName: Azure login and kubectl apply
      inputs:
        script: |
          echo Logging into Azure using Service Principal
          az login ^
            --service-principal ^
            -u "%AZURE_CLIENT_ID%" ^
            -p "%AZURE_CLIENT_SECRET%" ^
            --tenant "%AZURE_TENANT_ID%"

          echo Setting subscription
          az account set --subscription "%AZURE_SUBSCRIPTION_ID%"

          echo Getting AKS credentials
          az aks get-credentials ^
            --resource-group devops-aks-rg ^
            --name devops-aks-cluster ^
            --overwrite-existing

          echo Deploying Kubernetes manifests
          kubectl apply -f k8s/

          echo Deployment completed
